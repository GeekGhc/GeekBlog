---
title: Redis分布式集群
date: 2019-03-02
categories:
  - Redis
tags:
    - redis
---
## 前言
`Redis`在**3.0**以后的版本支持了`Cluster` 那么我们首先会想到`Cluster`是解决怎样的应用场景

为了应对大流量访问下提供稳定的业务，集群化是存储的必然形态  之前的单点存储势必会有诸多隐患

而未来的发展趋势肯定是大数据和云计算的紧密集合 分布式架构也就可以很好的体现他的优势 

> 分布式是以缩短单个任务的执行时间来提升效率的，而集群则是通过提高单位时间内执行的任务数来提升效率

## 解决方案
目前的`Redis`的集群化方案有三种

- Twitter开发的twemproxy
- 豌豆荚开发的codis
- redis官方的redis-cluster

`redis-cluster`是三个里性能最强大的 因为他使用去中心化的思想 使用`hash slot`方式 将**16348**个`hash slot` 覆盖到所有节点上 

对于存储的每个`key`值 使用`CRC16(KEY)&16348=slot` 得到他对应的`hash slot` 并在访问`key`时就去找他的`hash slot`在哪一个节点上 

然后由当前访问节点从实际被分配了这个`hash slot`的节点去取数据 节点之间使用轻量协议通信 减少带宽占用 性能很高 

自动实现负载均衡与高可用 自动实现`failover`  并且支持动态扩展 官方已经玩到可以**1000**个节点 实现的复杂度低  因为他的去中心化思想免去了`proxy`的消耗 是全新的思路

## 基本介绍
`Redis` 集群是一个可以在多个 `Redis` 节点之间进行数据共享的设施`installation`

`Redis` 集群通过分区`partition`来提供一定程度的可用性`availability`： 即使集群中有一部分节点失效或者无法进行通讯， 集群也可以继续处理命令请求。

`Redis`集群提供了以下两个好处：
- 将数据自动切分`split`到多个节点的能力。
- 当集群中的一部分节点失效或者无法进行通讯时， 仍然可以继续处理命令请求的能力。

## 集群分区
常见的分区规则有哈希分区和顺序分区，redis集群使用了哈希分区。RedisCluster采用了哈希分区的'虚拟槽分区'方式(哈希分区节点取余，一致性哈希分区和虚拟槽分区)

RedisCluster采用嘘嘘你槽分区，所有的键根据哈希函数(CRC16[key]&16383)映射到0-16383槽内，一共16384个槽位。每个节点维护部分及槽所映射的键值数据

哈希函数： Hash() = CRC16[key]&16383 按位与

其中槽与节点的关系如下:

![1](/images/articles/2019-03-02/001.png)

![2](/images/articles/2019-03-02/002.png)

## 环境安装

本地安装`Redis`服务  我因为是`mac`环境  所以直接可以通过`homebrew`安装

```shell
$ brew install redis
```

为了搭建  目录这里新建了**6**个节点目录
![3](/images/articles/2019-03-02/003.png)

将`redis`安装包 执行`bin`目录分别`copy`到每个节点目录

![5](/images/articles/2019-03-02/005.png)

复制`redis`的配置文件到每个节点  注意本机的`conf`文件的地址为 `/usr/local/etc/redis.conf`

## RedisCluster 缺陷
1.键的批量操作支持有限，比如mset、mget,如果多个键映射再不同的槽，就不支持了

2.键的事务支持有限，当多个key分布在不同的节点时无法使用事务，同一个节点时支持事务的

3.键是数据分区的最小粒度，不能讲一个很大的键值映射到不同的节点

4.不支持多数据库，只有0,select 0

5.复制结构只支持单层结构，不支持树状结构